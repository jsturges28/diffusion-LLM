<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LLaDA Diffusion Visualizer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <!-- Animated background grid + floating characters -->
  <div id="bg-grid"></div>
  <div id="bg-floaters" aria-hidden="true"></div>

  <div id="app">
    <!-- Header -->
    <header id="header">
      <h1>
        <span class="title-accent">LLaDA</span> Diffusion Visualizer
      </h1>
      <nav id="header-nav">
        <a href="#" id="link-about" class="header-link">About</a>
        <a href="#" id="link-help" class="header-link">Help</a>
        <a href="#" id="link-settings" class="header-link">Settings</a>
        <span id="connection-badge" class="badge badge-disconnected">
          disconnected
        </span>
      </nav>
    </header>

    <!-- Controls panel -->
    <section id="controls">
      <div id="prompt-row">
        <label for="prompt-input">Prompt</label>
        <textarea
          id="prompt-input"
          rows="2"
          placeholder="Enter a prompt..."
          spellcheck="false"
        >Write a short explanation of REST APIs and show a Python requests example.</textarea>
      </div>

      <div id="mode-row">
        <label class="toggle-switch">
          <input type="checkbox" id="toggle-experimental" />
          <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Experimental</span>
        <span class="info-icon" aria-label="Experimental mode info">?
          <span class="tooltip">Removes recommended parameter bounds. Values outside the default range may produce erratic or unstable results.</span>
        </span>
      </div>

      <div id="param-row">
        <div class="param-group">
          <label for="param-steps">Steps
            <span class="param-range" id="range-steps"></span>
          </label>
          <input
            id="param-steps"
            type="number"
            step="1" value="128"
          />
        </div>
        <div class="param-group">
          <label for="param-gen-length">Gen Length
            <span class="param-range" id="range-gen-length"></span>
          </label>
          <input
            id="param-gen-length"
            type="number"
            step="1" value="160"
          />
        </div>
        <div class="param-group">
          <label for="param-block-length">Block Length
            <span class="param-range" id="range-block-length"></span>
          </label>
          <input
            id="param-block-length"
            type="number"
            step="1" value="160"
          />
        </div>
        <div class="param-group">
          <label for="param-temperature">Temperature
            <span class="param-range" id="range-temperature"></span>
          </label>
          <input
            id="param-temperature"
            type="number"
            step="0.05" value="0.0"
          />
        </div>
        <div class="param-group">
          <label for="param-cfg-scale">CFG Scale
            <span class="param-range" id="range-cfg-scale"></span>
          </label>
          <input
            id="param-cfg-scale"
            type="number"
            step="0.1" value="0.0"
          />
        </div>
        <div class="param-group">
          <label for="param-remasking">Remasking</label>
          <select id="param-remasking">
            <option value="low_confidence" selected>Low Confidence</option>
            <option value="random">Random</option>
          </select>
        </div>

        <div class="param-group param-group-btn">
          <button id="btn-generate" disabled>Generate</button>
          <button id="btn-cancel" class="btn-cancel" hidden>Cancel</button>
          <button id="btn-save" class="btn-save" hidden disabled>Save</button>
        </div>
      </div>

      <div id="validation-hint" hidden></div>
    </section>

    <!-- Diffusion output area -->
    <section id="output-section">
      <div id="output-area">
        <span id="output-placeholder">
          Diffusion output will appear here...
        </span>
      </div>
    </section>

    <!-- Frame scrubber (visible after generation completes) -->
    <section id="scrubber-section" hidden>
      <div id="scrubber-controls">
        <button id="btn-scrub-start" class="scrub-btn" title="First frame">&laquo;</button>
        <button id="btn-scrub-prev" class="scrub-btn" title="Previous frame">&lsaquo;</button>
        <input type="range" id="scrubber-slider" min="0" max="0" value="0" />
        <button id="btn-scrub-next" class="scrub-btn" title="Next frame">&rsaquo;</button>
        <button id="btn-scrub-end" class="scrub-btn" title="Last frame">&raquo;</button>
        <span id="scrubber-label">Frame 0 / 0</span>
      </div>
      <div id="remask-controls" hidden>
        <span id="remask-count">0 tokens selected</span>
        <button id="btn-clear-remask" class="btn-secondary">Clear</button>
        <button id="btn-resume" class="btn-resume" disabled>Resume</button>
      </div>
    </section>

    <!-- Status bar -->
    <footer id="status-bar">
      <span id="status-step">Step —/—</span>
      <span id="status-elapsed">Elapsed: —</span>
      <span id="status-message"></span>
    </footer>
  </div>

  <!-- About modal -->
  <div id="modal-about" class="modal-overlay hidden">
    <div class="modal-box">
      <button class="modal-close" aria-label="Close">&times;</button>
      <h2><span class="title-accent">LLaDA</span> Diffusion Visualizer</h2>
      <div class="modal-body">
        <p>This tool visualizes <strong>discrete diffusion language modeling</strong> in real time. Instead of generating text one token at a time (left to right), a diffusion LLM starts with a fully masked sequence and iteratively reveals tokens over many denoising steps.</p>
        <h3>How diffusion LLMs work</h3>
        <p>The <strong>forward process</strong> corrupts text by independently replacing each token with [MASK] at a rate controlled by a noise schedule. The <strong>reverse process</strong> starts from a fully masked canvas and uses a Transformer with bidirectional attention to predict all masked tokens simultaneously, then re-masks the least confident predictions. This is repeated for <em>N</em> steps until the sequence is fully resolved.</p>
        <p>The training objective is cross-entropy on masked positions, weighted by 1/<em>t</em>, providing a variational upper bound on negative log-likelihood.</p>
        <h3>About the model</h3>
        <p><strong>LLaDA-8B-Instruct</strong> is the first competitive large-scale discrete diffusion language model. It was pre-trained from scratch on 2.3 trillion tokens and fine-tuned on 4.5 million instruction pairs, achieving performance comparable to LLaMA 3 8B on standard benchmarks.</p>
        <p class="modal-links">
          <a href="https://arxiv.org/abs/2502.09992" target="_blank" rel="noopener">Paper (arXiv)</a>
          &middot;
          <a href="https://huggingface.co/GSAI-ML/LLaDA-8B-Instruct" target="_blank" rel="noopener">Model (Hugging Face)</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Help modal -->
  <div id="modal-help" class="modal-overlay hidden">
    <div class="modal-box">
      <button class="modal-close" aria-label="Close">&times;</button>
      <h2>Help</h2>
      <div class="modal-body">
        <h3>Quick start</h3>
        <ol>
          <li>Wait for the model to load (the overlay dismisses automatically).</li>
          <li>Type a prompt in the text area.</li>
          <li>Adjust parameters if desired, then click <strong>Generate</strong>.</li>
          <li>Watch the masked canvas (░) resolve into text in real time.</li>
          <li>Click <strong>Cancel</strong> at any time to halt the program.</li>
        </ol>
        <h3>Parameters</h3>
        <dl>
          <dt>Steps</dt>
          <dd>Number of denoising iterations. More steps produce higher quality output but take longer.</dd>
          <dt>Gen Length</dt>
          <dd>Number of tokens in the generated output. Must be divisible by Block Length.</dd>
          <dt>Block Length</dt>
          <dd>Block size for semi-autoregressive sampling. When smaller than Gen Length, blocks are generated left-to-right with diffusion within each block. Equal to Gen Length for pure diffusion.</dd>
          <dt>Temperature</dt>
          <dd>Gumbel noise temperature for categorical sampling. 0 = greedy (argmax). Higher values increase randomness.</dd>
          <dt>CFG Scale</dt>
          <dd>Classifier-free guidance strength. 0 = disabled. Higher values increase adherence to the prompt.</dd>
          <dt>Remasking</dt>
          <dd>Strategy for choosing which tokens to re-mask between steps. <em>Low Confidence</em> re-masks the least confident predictions. <em>Random</em> selects randomly.</dd>
        </dl>
        <h3>Saving results</h3>
        <p>After a generation completes, a <strong>Save</strong> button appears next to the controls. Clicking it saves the run to a timestamped folder under <code>Results/</code> containing:</p>
        <ul>
          <li><strong>metadata.json</strong> — prompt, parameters, and final output text.</li>
          <li><strong>final.txt</strong> — the decoded final text.</li>
          <li><strong>history.txt</strong> — frame-by-frame snapshots of the diffusion process.</li>
          <li><strong>diffusion.gif</strong> — an animated GIF visualizing the denoising progression.</li>
        </ul>
        <p>The button is disabled during generation and after a successful save to prevent duplicates. Starting a new generation resets it.</p>
        <h3>Experimental mode</h3>
        <p>The toggle above the parameter controls removes the recommended bounds, allowing extreme values for exploratory purposes. The default bounds represent the range that produces more consistent, stable results.</p>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="modal-settings" class="modal-overlay hidden">
    <div class="modal-box modal-box-sm">
      <button class="modal-close" aria-label="Close">&times;</button>
      <h2>Settings</h2>
      <div class="modal-body">
        <div class="settings-row">
          <label for="select-idle-display">Idle Display</label>
          <select id="select-idle-display">
            <option value="default" selected>Default (ASCII Scene)</option>
            <option value="donut">donut.c (Spinning Torus)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Model loading overlay -->
  <div id="loading-overlay">
    <div id="loading-content">
      <div class="spinner"></div>
      <p>Loading LLaDA-8B-Instruct model...</p>
      <p class="loading-sub">
        This may take ~30 seconds on first run.
      </p>
    </div>
  </div>

  <script src="/ascii_scene.js"></script>
  <script src="/app.js"></script>
</body>
</html>
